<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loop & If Components Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .example {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
    }
    .example h3 {
      margin-top: 0;
      color: #333;
    }
    button {
      padding: 8px 16px;
      margin: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f8f8f8;
      cursor: pointer;
    }
    button:hover {
      background: #e8e8e8;
    }
    .item {
      padding: 10px;
      margin: 5px 0;
      background: #f5f5f5;
      border-left: 3px solid #2196F3;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }
    .details {
      padding: 15px;
      margin: 10px 0;
      background: #e3f2fd;
      border-radius: 4px;
      border: 1px solid #2196F3;
    }
    input[type="text"] {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 300px;
    }
  </style>
</head>
<body>
  <h1>Loop & If Components</h1>
  <p>Reactive list rendering with reconciliation and conditional rendering</p>

  <div class="example">
    <loop-demo></loop-demo>
  </div>

  <div class="example">
    <if-demo></if-demo>
  </div>

  <div class="example">
    <combined-demo></combined-demo>
  </div>

  <script type="module">
    import { Component, html, reactive, Model, Loop, If } from '../dist/index.js';

    // Example 1: Loop Component with reconciliation
    class LoopDemo extends Component(HTMLElement) {
      static tag = 'loop-demo';

      constructor() {
        super();
        this.state = reactive({
          items: [
            { id: 1, title: 'Item 1', completed: false },
            { id: 2, title: 'Item 2', completed: false },
            { id: 3, title: 'Item 3', completed: false }
          ],
          nextId: 4
        });
      }

      addItem() {
        this.state.items.push({
          id: this.state.nextId++,
          title: `Item ${this.state.nextId - 1}`,
          completed: false
        });
      }

      removeItem(id) {
        this.state.items = this.state.items.filter(item => item.id !== id);
      }

      toggleItem(id) {
        const item = this.state.items.find(i => i.id === id);
        if (item) {
          item.completed = !item.completed;
        }
      }

      shuffleItems() {
        this.state.items = [...this.state.items].sort(() => Math.random() - 0.5);
      }

      render() {
        return html`
          <h3>Example 1: Loop Component with Reconciliation</h3>
          <p>Items are reconciled by ID - only changed items update!</p>

          <div>
            <button onclick="{addItem}">Add Item</button>
            <button onclick="{shuffleItems}">Shuffle</button>
          </div>

          <veda-loop items="{this.state.items}" item-key="id">
            <template>
              <item-component></item-component>
            </template>
          </veda-loop>

          <p><small>Open DevTools to see: only changed items re-render</small></p>
        `;
      }
    }

    // Item component for Loop
    class ItemComponent extends Component(HTMLElement) {
      static tag = 'item-component';

      connectedCallback() {
        super.connectedCallback();
        console.log('ItemComponent mounted:', this.model?.id);
      }

      disconnectedCallback() {
        console.log('ItemComponent unmounted:', this.model?.id);
        super.disconnectedCallback?.();
      }

      get title() {
        return this.model?.title || '';
      }

      get completed() {
        return this.model?.completed || false;
      }

      handleToggle() {
        const event = new CustomEvent('toggle-item', {
          detail: { id: this.model.id },
          bubbles: true
        });
        this.dispatchEvent(event);
      }

      handleRemove() {
        const event = new CustomEvent('remove-item', {
          detail: { id: this.model.id },
          bubbles: true
        });
        this.dispatchEvent(event);
      }

      render() {
        return html`
          <div class="item ${this.completed ? 'completed' : ''}">
            <span>
              <input type="checkbox" ${this.completed ? 'checked' : ''} onchange="{handleToggle}" />
              {this.title}
            </span>
            <button onclick="{handleRemove}">Remove</button>
          </div>
        `;
      }
    }

    // Example 2: If Component
    class IfDemo extends Component(HTMLElement) {
      static tag = 'if-demo';

      constructor() {
        super();
        this.state = reactive({
          showDetails: false,
          isLoggedIn: false
        });
      }

      toggleDetails() {
        this.state.showDetails = !this.state.showDetails;
      }

      toggleLogin() {
        this.state.isLoggedIn = !this.state.isLoggedIn;
      }

      render() {
        return html`
          <h3>Example 2: If Component</h3>
          <p>Conditional rendering - content only exists in DOM when visible</p>

          <div>
            <button onclick="{toggleDetails}">
              {this.state.showDetails ? 'Hide' : 'Show'} Details
            </button>
            <button onclick="{toggleLogin}">
              {this.state.isLoggedIn ? 'Logout' : 'Login'}
            </button>
          </div>

          <veda-if condition="{this.state.showDetails}">
            <div class="details">
              <h4>Details Section</h4>
              <p>This content is only in DOM when showDetails is true!</p>
              <p>Open DevTools to verify.</p>
            </div>
          </veda-if>

          <veda-if condition="{this.state.isLoggedIn}">
            <div class="details">
              <h4>Welcome back!</h4>
              <p>You are logged in.</p>
            </div>
          </veda-if>

          <veda-if condition="{!this.state.isLoggedIn}">
            <div class="details">
              <p>Please log in to continue.</p>
            </div>
          </veda-if>
        `;
      }
    }

    // Example 3: Combined Loop + If
    class CombinedDemo extends Component(HTMLElement) {
      static tag = 'combined-demo';

      constructor() {
        super();
        this.state = reactive({
          filter: 'all',
          items: [
            { id: 1, title: 'Buy milk', completed: false },
            { id: 2, title: 'Walk dog', completed: true },
            { id: 3, title: 'Write code', completed: false },
            { id: 4, title: 'Read book', completed: true }
          ]
        });
      }

      get filteredItems() {
        if (this.state.filter === 'active') {
          return this.state.items.filter(i => !i.completed);
        }
        if (this.state.filter === 'completed') {
          return this.state.items.filter(i => i.completed);
        }
        return this.state.items;
      }

      get hasItems() {
        return this.state.items.length > 0;
      }

      get hasCompletedItems() {
        return this.state.items.some(i => i.completed);
      }

      setFilter(filter) {
        this.state.filter = filter;
      }

      clearCompleted() {
        this.state.items = this.state.items.filter(i => !i.completed);
      }

      render() {
        return html`
          <h3>Example 3: Combined Loop + If</h3>
          <p>TodoMVC-style: filtering + conditional rendering</p>

          <div>
            <button onclick="{() => this.setFilter('all')}"
                    style="font-weight: ${this.state.filter === 'all' ? 'bold' : 'normal'}">
              All
            </button>
            <button onclick="{() => this.setFilter('active')}"
                    style="font-weight: ${this.state.filter === 'active' ? 'bold' : 'normal'}">
              Active
            </button>
            <button onclick="{() => this.setFilter('completed')}"
                    style="font-weight: ${this.state.filter === 'completed' ? 'bold' : 'normal'}">
              Completed
            </button>
          </div>

          <veda-if condition="{this.hasItems}">
            <veda-loop items="{this.filteredItems}" item-key="id">
              <template>
                <simple-item></simple-item>
              </template>
            </veda-loop>
          </veda-if>

          <veda-if condition="{!this.hasItems}">
            <p><em>No items to show</em></p>
          </veda-if>

          <veda-if condition="{this.hasCompletedItems}">
            <button onclick="{clearCompleted}">Clear Completed</button>
          </veda-if>
        `;
      }
    }

    // Simple item component
    class SimpleItem extends Component(HTMLElement) {
      static tag = 'simple-item';

      render() {
        return html`
          <div class="item ${this.model?.completed ? 'completed' : ''}">
            {this.model?.title}
          </div>
        `;
      }
    }

    // Register components
    customElements.define(LoopDemo.tag, LoopDemo);
    customElements.define(ItemComponent.tag, ItemComponent);
    customElements.define(IfDemo.tag, IfDemo);
    customElements.define(CombinedDemo.tag, CombinedDemo);
    customElements.define(SimpleItem.tag, SimpleItem);

    // Setup event delegation for loop-demo
    document.addEventListener('toggle-item', (e) => {
      const demo = document.querySelector('loop-demo');
      if (demo) {
        demo.toggleItem(e.detail.id);
      }
    });

    document.addEventListener('remove-item', (e) => {
      const demo = document.querySelector('loop-demo');
      if (demo) {
        demo.removeItem(e.detail.id);
      }
    });
  </script>
</body>
</html>

